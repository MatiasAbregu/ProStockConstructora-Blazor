@page "/obra"
@using System.Net.Http.Json
@using DTO.DTOs_Obras
@using DTO.Enum
@using DTO.DTOs_Usuarios
@inject HttpClient Http
@inject ProStockConstructora.Client.DatosSesion DatosSesion



<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
        <div>
            <h3 class="mb-0"><i class="bi bi-building"></i> Obras</h3>
            <small class="text-muted">Listado y creación de obras (no se muestran finalizadas)</small>
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" @onclick="CargarObras">
                <i class="bi bi-arrow-clockwise me-1"></i> Recargar
            </button>
            <button class="btn btn-success" @onclick="AbrirModal">
                <i class="bi bi-plus-circle me-1"></i> Nueva Obra
            </button>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(Mensaje))
    {
        <div class="alert @ClaseAlerta" role="alert">@Mensaje</div>
    }

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead class="table-primary text-center">
                        <tr>
                            <th style="width:24%;">Código</th>
                            <th>Nombre</th>
                            <th style="width:24%;">Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Obras is null)
                        {
                            <tr><td colspan="3" class="text-center text-muted">Cargando obras...</td></tr>
                        }
                        else if (!Obras.Any())
                        {
                            <tr><td colspan="3" class="text-center text-muted">No hay obras registradas.</td></tr>
                        }
                        else
                        {
                            @foreach (var o in Obras)
                            {
                                if (!string.Equals(o.Estado, "Finalizada", StringComparison.OrdinalIgnoreCase))
                                {
                                    <tr>
                                        <td class="text-center">@o.CodigoObra</td>
                                        <td>@o.NombreObra</td>
                                        <td class="text-center">@o.Estado</td>
                                    </tr>
                                }
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


@if (MostrarModal)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-plus-lg me-2"></i> Nueva Obra</h5>
                    <button type="button" class="btn-close" @onclick="CerrarModal"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Código de Obra</label>
                        <input class="form-control" @bind="NuevaObra.CodigoObra" placeholder="OB-001" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Nombre de Obra</label>
                        <input class="form-control" @bind="NuevaObra.NombreObra" placeholder="Nombre de la obra" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Estado</label>
                        <select class="form-select" @bind="NuevaObra.Estado">
                            @foreach (var e in EstadosPermitidos)
                            {
                                <option value="@e">@FormateaEstado(e)</option>
                            }
                        </select>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CerrarModal">Cancelar</button>
                    <button class="btn btn-primary" @onclick="CrearObraAsync" disabled="@Guardando">
                        @if (Guardando)
                        {
                            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                            
                                        }
                        else
                        {
                            <i class="bi bi-check-lg me-1">Guardar</i>
                            
                                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
   

    private int EmpresaId = 1;

    // Esto es lo que va a mostrar mi tabla


    private List<VerObraDTO> Obras;

   
    private CrearObraDTO NuevaObra;

    private bool MostrarModal = false;
    private bool Guardando = false;

    private string Mensaje = string.Empty;
    private string ClaseAlerta = "alert-info";

    
    private EnumEstadoObra[] EstadosPermitidos = new[] { EnumEstadoObra.EnProceso, EnumEstadoObra.Pausada };

    
    protected override async Task OnInitializedAsync()
    {
        


        NuevaObra = new CrearObraDTO
        {
            CodigoObra = string.Empty,
            NombreObra = string.Empty,
            Estado = EnumEstadoObra.EnProceso
            
        };

        
        await CargarObras();
    }

    


    private async Task CargarObras()
    {
        Mensaje = string.Empty;
        ClaseAlerta = "alert-info";

        try
        {
            
            var url = $"api/obra/empresa/{EmpresaId}";
            var res = await Http.GetAsync(url);

            if (res.IsSuccessStatusCode)
            {
                var list = await res.Content.ReadFromJsonAsync<List<VerObraDTO>>();
                Obras = list ?? new List<VerObraDTO>();
            }
            else
            {
                Obras = new List<VerObraDTO>();
                

                var text = await res.Content.ReadAsStringAsync();
                Mensaje = string.IsNullOrWhiteSpace(text) ? $"Error: {res.ReasonPhrase}" : text;
                ClaseAlerta = "alert-warning";
            }
        }
        catch (Exception ex)
        {
            Obras = new List<VerObraDTO>();
            Mensaje = $"Error al cargar obras: {ex.Message}";
            ClaseAlerta = "alert-danger";
        }
    }

    private void AbrirModal()
    {
        NuevaObra = new CrearObraDTO
        {
            CodigoObra = string.Empty,
            NombreObra = string.Empty,
            Estado = EnumEstadoObra.EnProceso
        };
        MostrarModal = true;
        Mensaje = string.Empty;
    }

    private void CerrarModal()
    {
        MostrarModal = false;
    }

    private async Task CrearObraAsync()
    {
        Mensaje = string.Empty;
        ClaseAlerta = "alert-info";

        // Hago unas validaciones simples

        if (string.IsNullOrWhiteSpace(NuevaObra.CodigoObra) || string.IsNullOrWhiteSpace(NuevaObra.NombreObra))
        {
            Mensaje = "Completa Código y Nombre de la obra.";
            ClaseAlerta = "alert-warning";
            return;
        }

        Guardando = true;
        try
        {
            
            NuevaObra.EmpresaId = EmpresaId;

            var response = await Http.PostAsJsonAsync("api/obra", NuevaObra);

            if (response.IsSuccessStatusCode)
            {
                ClaseAlerta = "alert-success";
                Mensaje = "Obra creada con éxito.";

                // Actualizamos la lista para ver la nueva obra.... Aunque aun no me funciona...
                await CargarObras();
                CerrarModal();
            }
            else
            {
                var text = await response.Content.ReadAsStringAsync();
                Mensaje = string.IsNullOrWhiteSpace(text) ? $"Error: {response.ReasonPhrase}" : text;
                ClaseAlerta = "alert-danger";
            }
        }
        catch (Exception ex)
        {
            Mensaje = $"Error al crear obra: {ex.Message}";
            ClaseAlerta = "alert-danger";
        }
        finally
        {
            Guardando = false;
        }
    }

    


    private string FormateaEstado(EnumEstadoObra e)
    {
        return e == EnumEstadoObra.EnProceso ? "En proceso"
             : e == EnumEstadoObra.Pausada ? "En pausa"
             : e.ToString();
    }
}

