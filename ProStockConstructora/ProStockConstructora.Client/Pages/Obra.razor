@page "/obra"
@using System.Net.Http.Json
@using DTO.DTOs_Obras
@using DTO.Enum
@inject HttpClient Http



<h3 class="mb-3">Obras</h3>


<div class="container">
    
    <div class="row mb-3">
        <div class="col-12 col-md-6 d-flex gap-2 align-items-center">

            <!-- EmpresaId: para cargar las obras de la empresa -->
            <label class="me-2" for="empresaId">Empresa ID</label>
            <input id="empresaId" class="form-control w-50" @bind="EmpresaId" type="number" />

            <button class="btn btn-primary" @onclick="CargarObras">Cargar Obras</button>
        </div>

        <div class="col-12 col-md-6 text-md-end mt-2 mt-md-0">
            <!-- Botón para mostrar el formulario de creación -->
            <button class="btn btn-success" @onclick="CrearObra">+ Nueva Obra</button>
        </div>
    </div>

    <!-- Mensajes simples -->
    @if (!string.IsNullOrEmpty(Mensaje))
    {
        <div class="alert @AlertaClase">@Mensaje</div>
    }

    
    @if (MostrarFormulario)
    {
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">@FormularioTitulo</h5>
                <div class="row g-2">
                    <div class="col-12 col-md-4">
                        <label class="form-label">Código de obra</label>
                        <input class="form-control" @bind="Modelo.CodigoObra" />
                        <small class="text-muted">Código único por empresa</small>
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Nombre de la obra</label>
                        <input class="form-control" @bind="Modelo.NombreObra" />
                    </div>
                    <div class="col-12 col-md-2">
                        <label class="form-label">Estado</label>
                        <select class="form-select" @bind="EstadoSeleccionado">
                            <option value="@EnumEstadoObra.EnProceso">En proceso</option>
                            <option value="@EnumEstadoObra.Pausada">Pausada</option>
                            <option value="@EnumEstadoObra.Finalizada">Finalizada</option>
                        </select>
                    </div>
                </div>

                <div class="mt-3 d-flex gap-2">
                    <button class="btn btn-primary" @onclick="Guardar">Guardar</button>
                    <button class="btn btn-secondary" @onclick="CancelarFormulario">Cancelar</button>
                </div>
            </div>
        </div>
 }

 

    <div class="row">
        <div class="col-12">
            @if (Cargando)
            {
                <div class="text-center my-3">Cargando obras...</div>
            }
            else if (Obras == null || Obras.Count == 0)
            {
                <div class="text-center my-3">No hay obras registradas para esa empresa.</div>
            }
            else
            {
                
                <div class="table-responsive d-none d-md-block">
                    <table class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Código</th>
                                <th>Nombre</th>
                                <th>Estado</th>
                                <th class="text-end">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var o in Obras)
                            {
                                <tr>
                                    <td>@o.Id</td>
                                    <td>@o.CodigoObra</td>
                                    <td>@o.NombreObra</td>
                                    <td>@o.Estado</td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-info me-1" @onclick="() => VerObra(o.Id)">Ver</button>
                                        <button class="btn btn-sm btn-warning me-1" @onclick="() => EditarObra(o.Id)">Editar</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                
                <div class="d-block d-md-none">
                    <div class="row g-2">
                        @foreach (var o in Obras)
                        {
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <div class="fw-bold">@o.NombreObra</div>
                                                <div class="small">Código: @o.CodigoObra</div>
                                                <div class="small">Estado: @o.Estado</div>
                                            </div>
                                            <div class="text-end">
                                                <button class="btn btn-sm btn-info mb-1" @onclick="() => VerObra(o.Id)">Ver</button>
                                                <button class="btn btn-sm btn-warning" @onclick="() => EditarObra(o.Id)">Editar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    
    int EmpresaId { get; set; } = 0;    // poner el id de la empresa que quieras consultar
    bool Cargando { get; set; } = false;
    string Mensaje { get; set; } = string.Empty;
    string AlertaClase { get; set; } = "alert-info";

    List<VerObraDTO> Obras { get; set; } = new List<VerObraDTO>();

    
    bool MostrarFormulario { get; set; } = false;
    string FormularioTitulo { get; set; } = "Nueva Obra";

    // Modelo para crear

    CrearObraDTO Modelo { get; set; } = new CrearObraDTO { EmpresaId = 0, Estado = EnumEstadoObra.EnProceso };
    EnumEstadoObra EstadoSeleccionado { get; set; } = EnumEstadoObra.EnProceso;

    // Si estamos editando, guardamos el id:
    int EditandoId { get; set; } = 0;

    



    // Cargar obras por el Id de la Empresa


    async Task CargarObras()
    {
        Mensaje = string.Empty;
        if (EmpresaId <= 0)
        {
            Mensaje = "Ingrese un ID de empresa válido.";
            AlertaClase = "alert-warning";
            return;
        }

        try
        {
            Cargando = true;
            
            var resp = await Http.GetAsync($"api/obra/empresa/{EmpresaId}");
            if (!resp.IsSuccessStatusCode)
            {
                // si devuelve 200 con mensaje, por ejemplo "No hay obras registradas." lo tratamos igual:
                var txt = await resp.Content.ReadAsStringAsync();
                Mensaje = $"Respuesta servidor: {txt}";
                AlertaClase = "alert-info";
                Obras = new List<VerObraDTO>();
            }
            else
            {
                // deserializamos la lista
                Obras = await resp.Content.ReadFromJsonAsync<List<VerObraDTO>>() ?? new List<VerObraDTO>();
            }
        }
        catch (Exception ex)
        {
            Mensaje = $"Error al comunicarse con el servidor: {ex.Message}";
            AlertaClase = "alert-danger";
        }
        finally
        {
            Cargando = false;
        }
    }

    // Mostrar formulario para crear

    void CrearObra()
    {
        FormularioTitulo = "Crear nueva obra";
        MostrarFormulario = true;
        EditandoId = 0;
        Modelo = new CrearObraDTO { EmpresaId = EmpresaId, Estado = EnumEstadoObra.EnProceso };
        EstadoSeleccionado = EnumEstadoObra.EnProceso;
    }

    // Cancelar formulario
    void CancelarFormulario()
    {
        MostrarFormulario = false;
        Mensaje = string.Empty;
    }

    // Guardar (crear o actualizar según EditandoId)
    async Task Guardar()
    {
        Mensaje = string.Empty;

        // Validaciones simples (explicación: comprobamos que haya valores mínimos)


        if (string.IsNullOrWhiteSpace(Modelo.CodigoObra) || string.IsNullOrWhiteSpace(Modelo.NombreObra))
        {
            Mensaje = "Complete Código y Nombre de la obra.";
            AlertaClase = "alert-warning";
            return;
        }
        if (EmpresaId <= 0)
        {
            Mensaje = "Asigne un Empresa ID válido antes de guardar.";
            AlertaClase = "alert-warning";
            return;
        }

        try
        {
            // sincronizar estado seleccionado

            Modelo.Estado = EstadoSeleccionado;
            Modelo.EmpresaId = EmpresaId;

            if (EditandoId == 0)
            {
                // Crear 

                var postResp = await Http.PostAsJsonAsync("api/obra", Modelo);
                if (!postResp.IsSuccessStatusCode)
                {
                    var txt = await postResp.Content.ReadAsStringAsync();
                    Mensaje = $"No se pudo crear la obra: {txt}";
                    AlertaClase = "alert-danger";
                    return;
                }
                Mensaje = "Obra creada con éxito.";
                AlertaClase = "alert-success";
            }
            else
            {
                // Actualizar 

                var actualizarDTO = new ObraActualizarDTO
                {
                    Id = EditandoId,
                    CodigoObra = Modelo.CodigoObra,
                    NombreObra = Modelo.NombreObra,
                    Estado = Modelo.Estado
                };

                var putResp = await Http.PutAsJsonAsync($"api/obra/{EditandoId}", actualizarDTO);
                if (!putResp.IsSuccessStatusCode)
                {
                    var txt = await putResp.Content.ReadAsStringAsync();
                    Mensaje = $"No se pudo actualizar la obra: {txt}";
                    AlertaClase = "alert-danger";
                    return;
                }
                Mensaje = "Obra actualizada con éxito.";
                AlertaClase = "alert-success";
            }

            // refrescar lista
            await CargarObras();

            // ocultar formulario
            MostrarFormulario = false;
            EditandoId = 0;
        }
        catch (Exception ex)
        {
            Mensaje = $"Error: {ex.Message}";
            AlertaClase = "alert-danger";
        }
    }

    // Ver detalles 

    async Task VerObra(long id)
    {
        Mensaje = string.Empty;
        try
        {
            var resp = await Http.GetAsync($"api/obra/{id}");
            if (!resp.IsSuccessStatusCode)
            {
                var txt = await resp.Content.ReadAsStringAsync();
                Mensaje = $"No se pudo obtener la obra: {txt}";
                AlertaClase = "alert-warning";
                return;
            }

            var obra = await resp.Content.ReadFromJsonAsync<VerObraDTO>();
            if (obra == null)
            {
                Mensaje = "No se encontró la obra.";
                AlertaClase = "alert-info";
                return;
            }

            // Mostramos los datos en el formulario en modo ver
            FormularioTitulo = $"Ver obra - {obra.NombreObra}";
            MostrarFormulario = true;
            EditandoId = (int)obra.Id;
            Modelo = new CrearObraDTO
            {
                EmpresaId = EmpresaId,
                CodigoObra = obra.CodigoObra,
                NombreObra = obra.NombreObra,
                Estado = obra.Estado == "En proceso" ? EnumEstadoObra.EnProceso :
                         obra.Estado == "Pausada" ? EnumEstadoObra.Pausada : EnumEstadoObra.Finalizada
            };
            EstadoSeleccionado = Modelo.Estado;
        }
        catch (Exception ex)
        {
            Mensaje = $"Error al comunicarse con el servidor: {ex.Message}";
            AlertaClase = "alert-danger";
        }
    }

    // Editar: similar a ver, pero título distinto
    async Task EditarObra(long id)
    {
        await VerObra(id);
        FormularioTitulo = "Editar obra";
    }

    // ---------- Clases DTO locales (si tu cliente ya tiene referencias a DTOs compartidos,
    // puedes eliminar estas definiciones y usar las de tu proyecto "DTOs") ----------
    // (Si ya tienes las clases en un proyecto compartido, borra el bloque siguiente.)

    // Nota: si en tu cliente ya existe "DTO.DTOs_Obras", ignora / elimina estas clases duplicadas.

    // --- Fin código ---
}
