@page "/obras/editar/{ObraId:long}"
@inject IHttpServicio http
@inject DatosSesion datosSesion
@inject NavigationManager navManager

<PageTitle>Editar Obra - ProStock</PageTitle>

@if (datosSesion.Usuario != null &&
    (datosSesion.Usuario.Roles.Contains("ADMINISTRADOR") || datosSesion.Usuario.Roles.Contains("JEFEDEOBRA")))
{
    <div class="p-4">
        <div class="cabecera">
            <p class="fw-bolder">Editar obra</p>
            <a class="btn btn-secondary" href="/usuarios"><i class="fas fa-arrow-circle-left"></i>&ensp; Atrás</a>
        </div>
        <div class="card">
            @if (!string.IsNullOrEmpty(mensaje))
            {
                <div class="alert alert-danger text-center mx-2 mt-2">
                    @mensaje
                </div>
            }

            <EditForm Model="actualizarObra" OnValidSubmit="GuardarObra">
                <DataAnnotationsValidator />
                <div class="my-3 px-4">
                    <label class="form-label fw-bold">Código de Obra</label>
                    <InputText type="text" class="form-control" @bind-Value="actualizarObra.CodigoObra" placeholder="Ej: OB001" />
                    <ValidationMessage For="@(() => actualizarObra.CodigoObra)" />
                </div>
                <div class="my-3 px-4">
                    <label class="form-label fw-bold">Nombre de Obra</label>
                    <InputText type="text" class="form-control" @bind-Value="actualizarObra.NombreObra" placeholder="Ej: Edificio Central" />
                    <ValidationMessage For="@(() => actualizarObra.NombreObra)" />
                </div>
                <div class="my-3 px-4">
                    <label class="form-label fw-bold">Estado</label>
                    <InputSelect class="form-select" @bind-Value="actualizarObra.Estado">
                        <option value="@EnumEstadoObra.EnProceso">En proceso</option>
                        <option value="@EnumEstadoObra.Pausada">Pausada</option>
                    </InputSelect>
                    <ValidationMessage For="@(() => actualizarObra.Estado)" />
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success mb-2 btn-submit" type="submit">
                        <i class="bi bi-check-lg me-1"></i> Guardar
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
}
else
{
    navManager.NavigateTo("/");
}

@code {
    [Parameter]
    public long ObraId { get; set; }
    private DatosUsuario usuario;
    private ObraActualizarDTO actualizarObra = new();
    private string mensaje;

    protected async override void OnInitialized()
    {
        base.OnInitialized();
        usuario = datosSesion.Usuario;
        await ObtenerObra();
    }

    private async Task ObtenerObra()
    {
        var res = await http.Get<Response<ObraActualizarDTO>>($"api/obra/{ObraId}");
        if (res.Respuesta != null)
        {
            if (res.Respuesta.Objeto != null)
            {
                actualizarObra = res.Respuesta.Objeto;
            }
            else mensaje = res.Respuesta.Mensaje;
        }
        StateHasChanged();
    }

    private async Task GuardarObra()
    {
        var res = await http.Put<ObraActualizarDTO, Response<string>>($"api/obra/{ObraId}", actualizarObra);
        if (res.Respuesta != null)
        {
            if (!string.IsNullOrEmpty(res.Respuesta.Objeto)) navManager.NavigateTo("/obras");
            else mensaje = res.Respuesta.Mensaje;
        }
    }
}