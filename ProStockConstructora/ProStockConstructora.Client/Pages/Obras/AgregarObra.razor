@page "/obras/agregar-obra"
@inject IHttpServicio http
@inject DatosSesion datosSesion
@inject NavigationManager navManager

<PageTitle>Agregar Obra - ProStockConstructora</PageTitle>

@if (datosSesion.Usuario != null &&
	(datosSesion.Usuario.Roles.Contains("ADMINISTRADOR") || datosSesion.Usuario.Roles.Contains("JEFEDEOBRA")))
{
	<div class="container py-4">
		<div class="d-flex justify-content-between align-items-center mb-3">
			<h3 class="fw-bold text-primary">Agregar Obra</h3>
			<a class="btn btn-secondary" href="/obras"><i class="fas fa-arrow-circle-left"></i>&ensp; Atrás</a>
		</div>

		@if (!string.IsNullOrEmpty(mensaje))
		{
			<div class="alert alert-danger text-center">
				@mensaje
			</div>
		}

		<EditForm Model="nuevaObra" OnValidSubmit="GuardarObra">
			<DataAnnotationsValidator />
			<ValidationSummary />
			<!-- Campo Código -->
			<div class="mb-3">
				<label class="form-label fw-bold">Código de Obra</label>
				<input type="text" class="form-control" @bind="nuevaObra.CodigoObra" placeholder="Ej: OB001" />
			</div>
			<!-- Campo Nombre -->
			<div class="mb-3">
				<label class="form-label fw-bold">Nombre de Obra</label>
				<input type="text" class="form-control" @bind="nuevaObra.NombreObra" placeholder="Ej: Edificio Central" />
			</div>
			<!-- Campo Estado -->
			<div class="mb-3">
				<label class="form-label fw-bold">Estado</label>
				<select class="form-select" @bind="nuevaObra.Estado">
					<option value="@EnumEstadoObra.EnProceso">En proceso</option>
					<option value="@EnumEstadoObra.Pausada">Pausada</option>
				</select>
			</div>
			<div class="modal-footer">
				<button class="btn btn-success mb-2 btn-submit" type="submit">
					<i class="bi bi-check-lg me-1"></i> Guardar
				</button>
			</div>
		</EditForm>
	</div>
}
else
{
	navManager.NavigateTo("/");
}

@code {
	private DatosUsuario usuario;
	private CrearObraDTO nuevaObra;
	private string mensaje;

	protected override void OnInitialized()
	{
		base.OnInitialized();
		usuario = datosSesion.Usuario;
		nuevaObra = new CrearObraDTO() { EmpresaId = usuario.EmpresaId, Estado = EnumEstadoObra.EnProceso };
	}

	private async Task GuardarObra()
	{
		var res = await http.Post<CrearObraDTO, Response<string>>("api/obra", nuevaObra);
		if (res.Respuesta != null)
		{
			if (!string.IsNullOrEmpty(res.Respuesta.Objeto)) navManager.NavigateTo("/obras");
			else mensaje = res.Respuesta.Mensaje;
		}
	}
}