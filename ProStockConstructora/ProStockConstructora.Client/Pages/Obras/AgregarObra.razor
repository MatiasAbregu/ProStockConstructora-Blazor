@page "/obras/agregar-obra"
@inject IHttpServicio http
@inject DatosSesion datosSesion
@inject NavigationManager navManager

<PageTitle>Agregar Obra - ProStock</PageTitle>

@if (datosSesion.Usuario != null &&
    (datosSesion.Usuario.Roles.Contains("ADMINISTRADOR") || datosSesion.Usuario.Roles.Contains("JEFEDEOBRA")))
{
    <div class="p-4">
        <div class="cabecera">
            <p class="fw-bolder">Crear Obra</p>
            <a class="btn btn-secondary" href="/obras"><i class="fas fa-arrow-circle-left"></i>&ensp; Atrás</a>
        </div>
        <div class="card">
            @if (!string.IsNullOrEmpty(mensaje))
            {
                <div class="alert alert-danger text-center mx-2 mt-2">
                    @mensaje
                </div>
            }

            <EditForm Model="nuevaObra" OnValidSubmit="GuardarObra">
                <DataAnnotationsValidator />
                <div class="my-3 px-4">
                    <label class="form-label fw-bold">Código de Obra</label>
                    <InputText type="text" class="form-control" @bind-Value="nuevaObra.CodigoObra" placeholder="Ej: OB001" />
                    <ValidationMessage For="@(() => nuevaObra.CodigoObra)" />
                </div>
                <div class="my-3 px-4">
                    <label class="form-label fw-bold">Nombre de Obra</label>
                    <InputText type="text" class="form-control" @bind-Value="nuevaObra.NombreObra" placeholder="Ej: Edificio Central" />
                    <ValidationMessage For="@(() => nuevaObra.NombreObra)" />
                </div>
                <div class="my-3 px-4">
                    <label class="form-label fw-bold">Estado</label>
                    <InputSelect class="form-select" @bind-Value="nuevaObra.Estado">
                        <option value="@EnumEstadoObra.EnProceso">En proceso</option>
                        <option value="@EnumEstadoObra.Pausada">Pausada</option>
                    </InputSelect>
                    <ValidationMessage For="@(() => nuevaObra.Estado)" />
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success mb-2 btn-submit" type="submit">
                        <i class="bi bi-check-lg me-1"></i> Guardar
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
}
else
{
    navManager.NavigateTo("/");
}

@code {
    private DatosUsuario usuario;
    private CrearObraDTO nuevaObra;
    private string mensaje;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        usuario = datosSesion.Usuario;
        nuevaObra = new CrearObraDTO() { EmpresaId = usuario.EmpresaId, Estado = EnumEstadoObra.EnProceso };
    }

    private async Task GuardarObra()
    {
        var res = await http.Post<CrearObraDTO, Response<string>>("api/obra", nuevaObra);
        if (res.Respuesta != null)
        {
            if (!string.IsNullOrEmpty(res.Respuesta.Objeto)) navManager.NavigateTo("/obras");
            else mensaje = res.Respuesta.Mensaje;
        }
    }
}